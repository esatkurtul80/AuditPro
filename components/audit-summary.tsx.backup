"use client";

import { Audit, AuditAnswer } from "@/lib/types";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Star, FileText, Image as ImageIcon, ChevronDown, ChevronUp } from "lucide-react";
import { useState } from "react";
import {
    Collapsible,
    CollapsibleContent,
    CollapsibleTrigger,
} from "@/components/ui/collapsible";

interface AuditSummaryProps {
    audit: Audit;
}

// Helper: Check if answer is incomplete (did not receive full points)
function isIncompleteAnswer(answer: AuditAnswer): boolean {
    // Yes/No: "hayir" is incomplete
    if (answer.questionType === 'yes_no' || !answer.questionType) {
        return answer.answer === 'hayir';
    }

    // Rating, Multiple Choice, Checkbox: earnedPoints < maxPoints
    if (answer.questionType === 'rating' ||
        answer.questionType === 'multiple_choice' ||
        answer.questionType === 'checkbox') {
        return answer.earnedPoints < answer.maxPoints;
    }

    return false;
}

// Helper: Check if answer has notes
function hasNotes(answer: AuditAnswer): boolean {
    return !!(answer.notes && answer.notes.length > 0 && answer.notes.some(n => n.trim()));
}

export function AuditSummary({ audit }: AuditSummaryProps) {
    const [expandedSections, setExpandedSections] = useState<Record<string, boolean>>({});

    const toggleSection = (sectionId: string) => {
        setExpandedSections(prev => ({
            ...prev,
            [sectionId]: !prev[sectionId]
        }));
    };

    // Helper function to calculate counts for tabs
    const getCount = (type: 'all' | 'incomplete' | 'incomplete-notes') => {
        let count = 0;
        audit.sections.forEach(section => {
            section.answers.forEach(answer => {
                if (type === 'all') count++;
                else if (type === 'incomplete' && isIncompleteAnswer(answer)) count++;
                else if (type === 'incomplete-notes' && (isIncompleteAnswer(answer) || hasNotes(answer))) count++;
            });
        });
        return count;
    };

    const renderAnswer = (answer: AuditAnswer) => {
        // Yes/No Questions
        if (answer.questionType === 'yes_no' || !answer.questionType) {
            return (
                <Badge variant={answer.answer === 'hayir' ? 'destructive' : 'outline'} className={answer.answer === 'evet' ? 'bg-green-100 text-green-800 border-green-200 hover:bg-green-100' : ''}>
                    {answer.answer === 'evet' ? 'Evet' : answer.answer === 'hayir' ? 'HayÄ±r' : 'Muaf'}
                </Badge>
            );
        }

        // Rating Questions: Show stars
        if (answer.questionType === 'rating' && answer.ratingMax) {
            const rating = parseInt(answer.answer) || 0;
            return (
                <div className="flex items-center gap-1">
                    <div className="flex">
                        {Array.from({ length: answer.ratingMax }, (_, i) => (
                            <Star
                                key={i}
                                className={`h-4 w-4 ${i < rating ? 'fill-yellow-500 text-yellow-500' : 'text-gray-300'}`}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        // Multiple Choice: Show selected option
        if (answer.questionType === 'multiple_choice' && answer.options) {
            const selectedOption = answer.options.find(opt => opt.id === answer.answer);
            return selectedOption ? (
                <span className="text-sm font-medium">
                    {selectedOption.text}
                </span>
            ) : <span className="text-muted-foreground">-</span>;
        }

        // Checkbox: Show selected options count or list
        if (answer.questionType === 'checkbox' && answer.options) {
            const selectedIds = answer.selectedOptions || [];
            const uncheckedOpts = answer.options.filter(opt => !selectedIds.includes(opt.id));

            if (uncheckedOpts.length > 0) {
                return (
                    <div className="flex flex-col gap-1 text-xs">
                        <span className="text-muted-foreground">Eksikler:</span>
                        {uncheckedOpts.map(opt => (
                            <span key={opt.id} className="text-red-500 font-medium whitespace-normal">
                                â€¢ {opt.text}
                            </span>
                        ))}
                    </div>
                )
            }
            return <span className="text-green-600 font-medium text-sm">Tam Puan</span>
        }

        return <span className="text-sm">{answer.answer || '-'}</span>;
    };

    const renderMobileCard = (answer: AuditAnswer, sectionName: string, idx: number, qIdx: number) => {
        const isIncomplete = isIncompleteAnswer(answer);
        
        return (
            <Card key={`mobile-q-${idx}-${qIdx}`} className={`mb-3 ${isIncomplete ? 'border-red-200 bg-red-50/30' : 'border-gray-200'}`}>
                <CardContent className="p-4 space-y-3">
                    {/* Question */}
                    <div>
                        <span className="text-xs font-semibold text-muted-foreground uppercase tracking-wide">Soru</span>
                        <p className="text-sm font-medium text-foreground mt-1 leading-relaxed">
                            {answer.questionText}
                        </p>
                    </div>

                    {/* Answer */}
                    <div>
                        <span className="text-xs font-semibold text-muted-foreground uppercase tracking-wide">Cevap</span>
                        <div className="mt-1">
                            {renderAnswer(answer)}
                        </div>
                    </div>

                    {/* Score and Icons */}
                    <div className="flex items-center justify-between pt-2 border-t">
                        <div className="flex items-center gap-2">
                            <span className="text-xs text-muted-foreground">Puan:</span>
                            <span className={`text-lg font-bold ${isIncomplete ? 'text-red-500' : 'text-green-600'}`}>
                                {answer.earnedPoints}
                            </span>
                            <span className="text-sm text-muted-foreground">/ {answer.maxPoints}</span>
                        </div>

                        <div className="flex gap-3">
                            {hasNotes(answer) && (
                                <div className="flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-md">
                                    <FileText className="h-4 w-4 text-blue-600" />
                                    <span className="text-xs font-medium text-blue-600">Not</span>
                                </div>
                            )}
                            {answer.photos && answer.photos.length > 0 && (
                                <div className="flex items-center gap-1 bg-purple-50 px-2 py-1 rounded-md">
                                    <ImageIcon className="h-4 w-4 text-purple-600" />
                                    <span className="text-xs font-medium text-purple-600">{answer.photos.length}</span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Notes (if exists) */}
                    {hasNotes(answer) && (
                        <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <span className="text-xs font-semibold text-blue-700 uppercase tracking-wide">Notlar</span>
                            <div className="mt-1 text-sm text-blue-900 space-y-1">
                                {answer.notes?.filter(n => n.trim()).map((note, i) => (
                                    <p key={i} className="leading-relaxed">â€¢ {note}</p>
                                ))}
                            </div>
                        </div>
                    )}
                </CardContent>
            </Card>
        );
    };

    const renderSectionGroup = (filterType: 'all' | 'incomplete' | 'incomplete-notes') => {
        const hasAnyQuestions = audit.sections.some(section => {
            const filtered = section.answers.filter(a => {
                if (filterType === 'all') return true;
                if (filterType === 'incomplete') return isIncompleteAnswer(a);
                if (filterType === 'incomplete-notes') return isIncompleteAnswer(a) || hasNotes(a);
                return false;
            });
            return filtered.length > 0;
        });

        if (!hasAnyQuestions) {
            return (
                <Card>
                    <CardContent className="py-12 text-center text-muted-foreground">
                        {filterType === 'all'
                            ? "Soru bulunamadÄ±."
                            : filterType === 'incomplete'
                                ? "TÃ¼m sorularda tam puan alÄ±nmÄ±ÅŸ! ðŸŽ‰"
                                : "Puan alÄ±namayan veya notlu soru bulunamadÄ±."}
                    </CardContent>
                </Card>
            );
        }

        return (
            <>
                {/* Desktop View - Hidden on mobile */}
                <Card className="overflow-hidden border-muted-foreground/20 hidden lg:block">
                    <CardContent className="p-0">
                        <table className="w-full">
                            <thead>
                                <tr className="bg-muted hover:bg-muted border-b">
                                    <th className="w-[45%] font-bold text-foreground text-left py-3 px-4">Soru</th>
                                    <th className="w-[30%] font-bold text-foreground text-left py-3 px-4">Cevap</th>
                                    <th className="w-[15%] text-center font-bold text-foreground py-3 px-4">Puan</th>
                                    <th className="w-[10%] text-right pr-4 font-bold text-foreground py-3 px-4">Detay</th>
                                </tr>
                            </thead>
                            <tbody>
                                {audit.sections.map((section, idx) => {
                                    let sectionEarned = 0;
                                    let sectionMax = 0;
                                    section.answers.forEach(answer => {
                                        if (answer.answer && answer.answer.trim() !== "" && answer.answer !== "muaf") {
                                            sectionEarned += answer.earnedPoints;
                                            sectionMax += answer.maxPoints;
                                        }
                                    });

                                    const sectionScore = sectionMax > 0 ? Math.round((sectionEarned / sectionMax) * 100) : 0;

                                    const filteredQuestions = section.answers.filter(a => {
                                        if (filterType === 'all') return true;
                                        if (filterType === 'incomplete') return isIncompleteAnswer(a);
                                        if (filterType === 'incomplete-notes') return isIncompleteAnswer(a) || hasNotes(a);
                                        return false;
                                    });

                                    if (filteredQuestions.length === 0) return null;

                                    return (
                                        <>
                                            <tr key={`section-${idx}`} className="bg-muted/30 hover:bg-muted/40 border-t-2 border-muted">
                                                <td colSpan={4} className="py-3 px-4">
                                                    <div className="flex items-center justify-between">
                                                        <span className="font-bold text-base text-foreground pl-1">
                                                            {section.sectionName}
                                                        </span>
                                                        <div className="flex items-center justify-center bg-primary/10 rounded-full px-3 py-1">
                                                            <span className="text-sm font-bold text-primary">{sectionScore} Puan</span>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>

                                            {filteredQuestions.map((answer, qIdx) => (
                                                <tr key={`q-${idx}-${qIdx}`} className="hover:bg-muted/10 border-b">
                                                    <td className="align-top py-3 pl-6">
                                                        <span className="font-medium text-sm text-foreground/90 block mb-1">
                                                            {answer.questionText}
                                                        </span>
                                                    </td>
                                                    <td className="align-top py-3 px-4">
                                                        {renderAnswer(answer)}
                                                    </td>
                                                    <td className="text-center align-top py-3 px-4">
                                                        <div className="flex flex-col items-center">
                                                            <span className={`font-bold ${isIncompleteAnswer(answer) ? 'text-red-500' : 'text-green-600'}`}>
                                                                {answer.earnedPoints}
                                                            </span>
                                                            <span className="text-xs text-muted-foreground">
                                                                / {answer.maxPoints}
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <td className="text-right align-top py-3 pr-4">
                                                        <div className="flex justify-end gap-2">
                                                            {hasNotes(answer) && (
                                                                <div className="relative group cursor-help" title={answer.notes?.filter(n => n.trim()).join("\n")}>
                                                                    <FileText className="h-4 w-4 text-blue-500" />
                                                                </div>
                                                            )}
                                                            {answer.photos && answer.photos.length > 0 && (
                                                                <div className="relative group cursor-help" title={`${answer.photos.length} FotoÄŸraf`}>
                                                                    <ImageIcon className="h-4 w-4 text-purple-500" />
                                                                </div>
                                                            )}
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </>
                                    );
                                })}
                            </tbody>
                        </table>
                    </CardContent>
                </Card>

                {/* Mobile/Tablet View - Hidden on desktop */}
                <div className="space-y-4 lg:hidden">
                    {audit.sections.map((section, idx) => {
                        let sectionEarned = 0;
                        let sectionMax = 0;
                        section.answers.forEach(answer => {
                            if (answer.answer && answer.answer.trim() !== "" && answer.answer !== "muaf") {
                                sectionEarned += answer.earnedPoints;
                                sectionMax += answer.maxPoints;
                            }
                        });

                        const sectionScore = sectionMax > 0 ? Math.round((sectionEarned / sectionMax) * 100) : 0;

                        const filteredQuestions = section.answers.filter(a => {
                            if
